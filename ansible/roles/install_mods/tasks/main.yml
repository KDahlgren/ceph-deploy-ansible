- name: "copy setup files"
  copy:
    src: "{{ item }}"
    dest: "{{ local_home }}"
    mode: '0644'
  with_items:
    - ./files/format-device.sh

- name: "running format device"
  shell: sh format-device.sh {{ this_user }} {{ format_device }} ;
  ignore_errors: yes


# THIS ASSUMES MODS ARE PRE-BULIT FROM SKYHOOK!!!
- name: "copy modified bins"
  copy:
    src: "{{ item }}"
    dest: "/usr/bin/"
    mode: preserve
  with_items:
    - /mnt/sda4/skyhookdm-ceph/build/bin/ceph-osd

- name: "copy modified libs"
  copy:
    src: "{{ item }}"
    dest: "/usr/lib/x86_64-linux-gnu/"
    mode: preserve
  with_items:
    - /mnt/sda4/skyhookdm-ceph/build/lib/librados.so.2.0.0
    
- name: "copy modified rados-classes"
  copy:
    src: "{{ item }}"
    dest: "/usr/lib/x86_64-linux-gnu/rados-classes/"
    mode: preserve
  with_items:
    - /mnt/sda4/skyhookdm-ceph/build/lib/libcls_tabular.so.1.0.0
   
- name "clean up any existing symlinks"
  shell: |
    cd /usr/lib/x86_64-linux-gnu/rados-classes/; if test -f libcls_tabular.so.1; then sudo  unlink libcls_tabular.so.1; fi;
    cd /usr/lib/x86_64-linux-gnu/rados-classes/; if test -f libcls_tabular.so; then sudo unlink libcls_tabular.so; fi;
    cd /usr/lib/x86_64-linux-gnu/rados-classes/; if test -f librados.so.2; then sudo  unlink libcls_tabular.so.2; fi;
    cd /usr/lib/x86_64-linux-gnu/rados-classes/; if test -f librados.so; then sudo unlink libcls_tabular.so; fi;
  
- name: "make rados symlinks"
  shell: |
    cd /usr/lib/x86_64-linux-gnu/ ;
    sudo ln -s librados.so.2.0.0 librados.so.2 ;
    sudo ln -s librados.so.2 librados.so ;

- name: "make tabular symlinks"
  shell: |
    cd /usr/lib/x86_64-linux-gnu/rados-classes/ ;
    sudo ln -s libcls_tabular.so.1.0.0 libcls_tabular.so.1 ;
    sudo ln -s libcls_tabular.so.1 libcls_tabular.so ;
