- name: "copy setup files"
  copy:
    src: "{{ item }}"
    dest: "{{ local_home }}"
    mode: '0644'
  with_items:
    - ./files/format-device.sh

- name: "running format device"
  shell: sh format-device.sh {{ this_user }} {{ format_device }} ;
  ignore_errors: yes


# THIS ASSUMES MODS ARE IN SKYHOOK!!!!
- name: "clone skyhook repo"
  shell: |
    cd "/mnt/{{ format_device }}" ;
    git clone https://github.com/uccross/skyhookdm-ceph.git
    
- name: "setup skyhook repo"
  shell: |
    cd "/mnt/{{ format_device }}/skyhookdm-ceph" ;
    git checkout skyhook-pdsw19 ;
    
- name: "running install-deps"
  shell: |
    cd "/mnt/{{ format_device }}/skyhookdm-ceph" ;
    ./install-deps.sh ;
    
- name: "running do_cmake"
  shell: |
    cd "/mnt/{{ format_device }}/skyhookdm-ceph" ;
    ./do_cmake.sh ;

- name: "make ceph-osd"
  shell: |
    cd "/mnt/{{ format_device }}/skyhookdm-ceph/build" ;
    make -j36 ceph-osd ;

- name: "copy modified bins"
  copy:
    src: "{{ item }}"
    dest: "/usr/bin/"
    mode: preserve
  with_items:
    - /mnt/sda4/skyhookdm-ceph/build/bin/ceph-osd

# clean up
- name: "running install-deps"
  shell: |
    cd "/mnt/{{ format_device }}" ;
    rm -rf "/mnt/{{ format_device }}/skyhookdm-ceph";
